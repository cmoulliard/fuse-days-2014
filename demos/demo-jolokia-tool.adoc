# DEMO - jmx4perl, j4psh, REST with Jolokia

## Prerequisite - install jmx4perl tool of the jolokia project

* See doc here : http://jolokia.org/tutorial.html (Install Jmx4Perl and j4psh)

## Install jmx4perl

* Open a Unix terminal and start this command

  perl -MCPAN -e shell

* When cpan prompt appears, execute this intsruction to install jmx4perl

  install JMX::Jmx4Perl
  
  If you issues during test execution you can skip test processing using `force install CPAN_MODULE`
  
## Use `jmx4perl`

* Open 2 unix terminals and move to the project containing the hawtio embedded jetty server

  cd ~/MyProjects/MyConferences/fuse-days-2014/demos/hawtio-embedded
  
* Start the embedded client
  
  mvn exec:java
      
* Try out jmx4perl

  jmx4perl http://localhost:9090/hawtio/jolokia list
  
* If JBoss Fuse server has been started in another unix terminal, we can also query it

** To list all the mbeans
  
  jmx4perl http://admin:admin@localhost:8181/hawtio/jolokia list
  
** To get info of a specific attribute of a mbean
  
  jmx4perl http://admin:admin@localhost:8181/hawtio/jolokia read java.lang:type=Runtime SpecVersion
  1.7


## j4psh

* Open 2 terminals

  cd ~/MyProjects/MyConferences/fuse-days-2014/demos/hawtio-embedded

* Start the embedded client

  mvn exec:java

* Run j4psh commands to fetch data from the jolokia agent

  connect http://localhost:9090/hawtio/jolokia
    
WARNING: Due to a faulty reg expression, we can't connect to the Fuse server as it requires to pass a user:password within the http request. This PR should fix it - https://github.com/rhuss/jmx4perl/pull/47    
When the PR will be applied, than we will be able to use this connect string http request

  connect http://admin:admin@localhost:8181/hawtio/jolokia

* When we are connected to the server, we can navigate within the tree and fetch the data or execute some operations
* Get HeapMemoryUsage attribute

    ls
    cd java.lang
    cd type=Memory
    cat HeapMemoryUsage

* Get Camel info

    cd ..
    cd org.apache.camel
    ls

* Change to the route1 Mbean & get attribute ExchangeCompleted

    cd context=camel-1,name="route1",type=routes
    cat ExchangesCompleted

*  Execute operation to get Stats of a Camel route

    exec dumpStatsAsXml(boolean) true
    Return: <stats exchangesCompleted="61" exchangesFailed="0" failuresHandled="0" redeliveries="0" externalRedeliveries="0"
             minProcessingTime="0" maxProcessingTime="6" totalProcessingTime="67" lastProcessingTime="1" deltaProcessingTime="0"
             meanProcessingTime="1" resetTimestamp="2014-09-12T20:45:06.191+0200" firstExchangeCompletedTimestamp="2014-09-12T20:45:07.218+0200"
             firstExchangeCompletedExchangeId="ID-Dabou-local-60864-1410547505770-0-2" firstExchangeFailureTimestamp=""
             firstExchangeFailureExchangeId="" lastExchangeCompletedTimestamp="2014-09-12T20:55:07.238+0200"
             lastExchangeCompletedExchangeId="ID-Dabou-local-60864-1410547505770-0-122" lastExchangeFailureTimestamp="" lastExchangeFailureExchangeId=""/>

## REST

Instead of using the jmx4perl or j4psh jolokia tools, we can also fetch data from the jokokia bridge servlet using REST requests.
The following requests have been executed within a unix terminal using thehttps://github.com/jakubroztocil/httpie[`httpie tool`]

* Read +all mbeans+ info and save the JSON result into a file 
    
  http --pretty=all http://admin:admin@localhost:8181/hawtio/jolokia/list > result.json

* Mbean +java.lang+

** READ attribute

    http --pretty=all http://admin:admin@localhost:8181/hawtio/jolokia/read/java.lang:type=Memory/HeapMemoryUsage/used
    
** EXEC an operation    

    http --pretty=all http://admin:admin@localhost:8181/hawtio/jolokia/exec/java.lang:type=Memory/gc

* Mbean +org.apache.camel+

WARN : Add backslash before double quoted text

** READ ExchangesCompleted of a Camel Route ("route3") defined for the CamelContext (camel-demo-blueprint.xml)

    http --pretty=all http://admin:admin@localhost:8181/hawtio/jolokia/read/org.apache.camel:context=camel-demo-blueprint.xml,name=\"route3\",type=routes/ExchangesCompleted/
    HTTP/1.1 200 OK
    Access-Control-Allow-Origin: *
    Cache-Control: no-cache
    Content-Length: 194
    Content-Type: text/plain;charset=UTF-8
    Date: Thu, 30 Apr 2015 08:58:06 GMT
    Expires: Thu, 30 Apr 2015 07:58:06 GMT
    Pragma: no-cache
    Server: Jetty(8.1.14.v20131031)
    
    {"timestamp":1430384286,"status":200,"request":{"mbean":"org.apache.camel:context=camel-demo-blueprint.xml,name=\"route3\",type=routes","attribute":"ExchangesCompleted","type":"read"},"value":0}

** Execute the dumpStatsAsXml operation and setting the boolean value to true

    http http://admin:admin@localhost:8181/hawtio/jolokia/exec/org.apache.camel:context=camel-demo-blueprint.xml,name=\"route3\",type=routes/dumpStatsAsXml\(boolean\)/true
    HTTP/1.1 200 OK
    Access-Control-Allow-Origin: *
    Cache-Control: no-cache
    Content-Length: 967
    Content-Type: text/plain;charset=UTF-8
    Date: Thu, 30 Apr 2015 09:16:30 GMT
    Expires: Thu, 30 Apr 2015 08:16:30 GMT
    Pragma: no-cache
    Server: Jetty(8.1.14.v20131031)

    {"timestamp":1430385390,"status":200,"request":{"operation":"dumpStatsAsXml(boolean)","mbean":"org.apache.camel:context=camel-demo-blueprint.xml,name=\"route3\",type=routes","arguments":["true"],"type":"exec"},"value":"<stats exchangesCompleted=\"0\" exchangesFailed=\"426\" failuresHandled=\"0\" redeliveries=\"0\" externalRedeliveries=\"0\" minProcessingTime=\"0\" maxProcessingTime=\"0\" totalProcessingTime=\"0\" lastProcessingTime=\"0\" deltaProcessingTime=\"0\" meanProcessingTime=\"0\" resetTimestamp=\"2015-04-30T10:41:00.577+0200\" firstExchangeCompletedTimestamp=\"\" firstExchangeCompletedExchangeId=\"\" firstExchangeFailureTimestamp=\"2015-04-30T10:41:01.594+0200\" firstExchangeFailureExchangeId=\"ID-dabou-local-49325-1430383026073-1-2\" lastExchangeCompletedTimestamp=\"\" lastExchangeCompletedExchangeId=\"\" lastExchangeFailureTimestamp=\"2015-04-30T11:16:27.838+0200\" lastExchangeFailureExchangeId=\"ID-dabou-local-49325-1430383026073-1-852\"\/>"}
